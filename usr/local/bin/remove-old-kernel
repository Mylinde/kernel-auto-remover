#!/bin/bash

if [ -f /var/local/kernel-temp/old_kernel_version ]; then
    OLD_KERNEL=$(cat /var/local/kernel-temp/old_kernel_version)
    rm /var/local/kernel-temp/old_kernel_version

    # Determine current kernel version
    CURRENT_KERNEL=$(uname -r)

    # Determine current and old kernel version
    CURRENT_MAJOR=$(echo "$CURRENT_KERNEL" | cut -d'.' -f1-2)
    OLD_MAJOR=$(echo "$OLD_KERNEL" | cut -d'.' -f1-2)

    # If the major versions match
    if [ "$CURRENT_MAJOR" = "$OLD_MAJOR" ]; then
        # Remove kernel image and header
        apt-get -y purge linux-image-"$OLD_KERNEL" linux-headers-"$OLD_KERNEL"
    else
        echo "The kernel to be removed has a different major version than the active kernel."
    fi
fi
